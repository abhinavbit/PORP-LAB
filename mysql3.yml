---
- hosts: all
  become: True

  tasks:
     - name: Download Percona Repo
       get_url: 
          url: 'https://repo.percona.com/apt/percona-release_latest.xenial_all.deb'
          dest: '/tmp/percona-release_latest.xenial_all.deb'

     - name: Install Percona Repo
       apt:
          deb: '/tmp/percona-release_latest.xenial_all.deb'

     - name: update apt chache
       apt:   
          update_cache: yes

     - name: Install Percona Server
       apt:
         name: "{{ item }}" 
         state: present
         force: yes 
       vars:
         item:
            - percona-server-common-5.7
            - percona-server-client-5.7
            - percona-server-server-5.7
       environment:
          DEBIAN_FRONTEND: noninteractive

     - name: configure my.cnf
       template: 
         src: mysql3.my.cnf.j2 
         dest: /etc/mysql/my.cnf

     - name: restart mysql
       service:
             name: mysql
             state: restarted
             enabled: yes

     - name: Install Percona Toolkit
       apt:
         name: percona-toolkit
         state: present
         force: yes

     - name: Install dependency
       apt:
         name: python2.7-mysqldb
         state: present

     - name: Stop replication
       mysql_replication:
         mode: stopslave

     - name: Configure replication
       mysql_replication:
         mode: changemaster
         master_host: 192.168.135.111
         master_user: repl
         master_password: repl
         master_log_file: mysql1-bin.000001
         master_log_pos: 4

     - name: Start replication
       mysql_replication:
         mode: startslave

     - name: Check slave status
       mysql_replication:
         mode: getslave
